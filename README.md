### Easy Math Teaching — Telegram Bot with WebApp (Go + Echo + PostgreSQL)

This project implements a Telegram bot with a WebApp for viewing Canva content. It follows a clean and extensible architecture using Go, Echo, PostgreSQL, and go-telegram-bot-api.

Key features
- Two user roles: admin and client.
- Admin can add, edit, delete content via Telegram bot (class, quarter, topic, price, Canva iframe).
- Content stored in PostgreSQL.
- Clients can list content and open a preview WebApp inside Telegram.
- WebApp renders a backend-generated HTML page that contains the Canva iframe; the real Canva link is not exposed in the browser address bar.

Project layout
- cmd/server/main.go — application entrypoint (Echo HTTP server + Telegram bot runtime).
- internal/db — DB connection setup (pgxpool).
- internal/repo — repository layer with CRUD for contents table.
- internal/service — business logic: admin checks, add-flow FSM, token signing for secure WebApp access.
- internal/bot — Telegram transport layer: command parsing and updates processing, delegates to service.
- templates/ — HTML templates for /view and /webapp.
- migrations/ — SQL migration for initial schema.

Quick start
1) Configure environment variables (see .env.example):
   - TELEGRAM_BOT_TOKEN — bot token from @BotFather.
   - ADMIN_TELEGRAM_ID — numeric Telegram user id for admin.
   - DATABASE_URL — PostgreSQL URL (e.g. postgres://user:pass@host:5432/db?sslmode=disable)
   - PUBLIC_BASE_URL — public base URL used in bot buttons (e.g. https://your.domain)
   - WEBAPP_SECRET — secret for signing short-lived tokens for /webapp.
   - HTTP_ADDR — optional listen address for HTTP (default :8080)

2) Start PostgreSQL and apply migration (optional; app auto-creates table on startup):
   psql "$DATABASE_URL" -f migrations/001_contents_table.sql

3) Run the server:
   go run ./cmd/server

4) In Telegram, talk to your bot:
   - /start — intro
   - /list — list content
   - /add — (admin) interactive add flow
   - /edit <id> <field> <value> — (admin) fields: class, quarter, topic, price, iframe_html
   - /delete <id> — (admin)
   - Send "Смотреть" to receive a WebApp button to open a preview page.

Web endpoints
- GET /healthz — simple liveness probe.
- GET /view?id=<id> — outer page that embeds the internal WebApp via src=/webapp (...). Does not expose Canva URL in the browser bar.
- GET /webapp?id=<id>&token=<signed> — inner page rendered inside Telegram WebApp. Requires a valid signed token. Returns HTML with the raw iframe markup from database.

Security notes
- /webapp requires a signed short-lived token generated by the backend; tokens include content id and expiration and are HMAC-SHA256 signed with WEBAPP_SECRET.
- The public Canva embed code is only inserted server-side in the template; the direct link is not shown in the browser address line.

Example SQL (PostgreSQL)
See migrations/001_contents_table.sql:

CREATE TABLE IF NOT EXISTS contents (
    id BIGSERIAL PRIMARY KEY,
    class TEXT NOT NULL,
    quarter TEXT NOT NULL,
    topic TEXT NOT NULL,
    price NUMERIC(12,2) NOT NULL DEFAULT 0,
    iframe_html TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_contents_class ON contents(class);
CREATE INDEX IF NOT EXISTS idx_contents_quarter ON contents(quarter);
CREATE INDEX IF NOT EXISTS idx_contents_topic ON contents(topic);

Notes on architecture
- main sets up dependencies and starts both bot and HTTP server.
- repo package isolates DB operations.
- service package contains business rules, including:
  - admin checks via ID set;
  - conversational FSM for adding content from Telegram;
  - token signing/verification for /webapp access.
- templates contain simple pages to render iframe without exposing original link in the address bar.

Extending/payments
- Payment logic is intentionally left as a stub to keep the example minimal. You can integrate payments (e.g., Telegram Payments or external provider) and set flags in DB that unlock full content per topic/quarter/class.
- After payment, send the user a WebApp button linking to /view?id=<id>.

License
- MIT or your preferred license.
